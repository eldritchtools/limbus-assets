name: Sync to Cloudflare R2

on:
  push:
    branches:
      - main
    paths:
      - "data/**"
      - "assets/**"
  workflow_dispatch:

jobs:
  sync-assets:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create or update meta.json
        run: |
          echo "{\"datetime\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"}" > meta.json

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add meta.json
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update meta.json [skip ci]"
            git push
          fi

      - name: Install rclone
        run: curl https://rclone.org/install.sh | sudo bash

      # Configure temporary rclone remote for R2
      - name: Configure rclone for Cloudflare R2
        run: |
          mkdir -p ~/.config/rclone
          echo "[r2]" > ~/.config/rclone/rclone.conf
          echo "type = s3" >> ~/.config/rclone/rclone.conf
          echo "provider = Cloudflare" >> ~/.config/rclone/rclone.conf
          echo "access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}" >> ~/.config/rclone/rclone.conf
          echo "secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}" >> ~/.config/rclone/rclone.conf
          echo "endpoint = ${{ secrets.R2_JURISDICTION_SPECIFIC_ENDPOINT }}" >> ~/.config/rclone/rclone.conf

      # - name: List R2 buckets
      #   run: rclone ls "r2:${{ secrets.R2_BUCKET }}"

      - name: Sync assets to R2 (checksum-based)
        run: |
          rclone sync assets r2:$BUCKET/assets \
            --checksum \
            --fast-list \
            --s3-upload-headers "Cache-Control: public, max-age=2592000, immutable" \
            --s3-metadata-directive REPLACE

      - name: Sync data to R2 (checksum-based)
        run: |
          rclone sync data r2:${{ secrets.R2_BUCKET }}/data --checksum --fast-list

      - name: Sync meta to R2 (checksum-based)
        run: |
          rclone copyto meta.json r2:${{ secrets.R2_BUCKET }}/meta.json

      - name: Purge Cloudflare cache (only changed JSON files)
        run: |
          DOMAIN="${{ secrets.R2_CUSTOM_DOMAIN }}"
          ZONE_ID="${{ secrets.CF_ZONE_ID }}"
          TOKEN="${{ secrets.CF_PURGE_API_TOKEN }}"

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          # Find changed JSON files in data/ across the entire push
          if [ -n "$BEFORE" ] && [ -n "$AFTER" ]; then
            CHANGED_JSON=$(git diff --name-only "$BEFORE" "$AFTER" | grep '^data/.*\.json$' || true)
          else
            CHANGED_JSON=""
          fi

          # Always include meta.json
          FILES=("$DOMAIN/meta.json")

          # Convert paths to full URLs
          for file in $CHANGED_JSON; do
            FILES+=("$DOMAIN/$file")
          done

          printf 'Purging the following files:\n'
          printf ' - %s\n' "${FILES[@]}"

          # Build JSON payload safely
          PAYLOAD=$(jq -n --argjson files "$(printf '%s\n' "${FILES[@]}" | jq -R . | jq -s .)" \
            '{files: $files}')

          curl -X POST "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/purge_cache" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            --data "$PAYLOAD"
