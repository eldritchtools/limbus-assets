name: Sync to Cloudflare R2

on:
  push:
    branches:
      - main
    paths:
      - "data/**"
      - "assets/**"
  workflow_dispatch:

jobs:
  update-json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create or update meta.json
        run: |
          echo "{\"datetime\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"}" > meta.json

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add meta.json
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update meta.json [skip ci]"
            git push
          fi

      - name: Configure AWS CLI for R2
        run: |
          aws configure set aws_access_key_id ${{ secrets.R2_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.R2_SECRET_ACCESS_KEY }}
          aws configure set default.region auto

      - name: Upload assets, data, and meta.json to R2
        run: |
          ENDPOINT="${{ secrets.R2_JURISDICTION_SPECIFIC_ENDPOINT }}"
          BUCKET="${{ secrets.R2_BUCKET }}"

          # Sync assets/ and data/ folders
          aws s3 sync assets s3://$BUCKET/assets --endpoint-url $ENDPOINT --delete
          aws s3 sync data s3://$BUCKET/data --endpoint-url $ENDPOINT --delete

          # Upload meta.json
          aws s3 cp meta.json s3://$BUCKET/meta.json --endpoint-url $ENDPOINT

      - name: Purge Cloudflare cache
        run: |
          DOMAIN="${{ secrets.R2_CUSTOM_DOMAIN }}"

          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CF_PURGE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"files":["https://$DOMAIN/data/","https://$DOMAIN/meta.json"]}'
